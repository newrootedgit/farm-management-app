generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ============================================================================
// MULTI-TENANCY & AUTH
// ============================================================================

model Company {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  farms     Farm[]
  admins    User[]   @relation("CompanyAdmins")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Farm {
  id        String   @id @default(cuid())
  name      String
  slug      String
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  timezone String @default("UTC")
  currency String @default("USD")

  // Branding
  logoUrl    String?
  brandColor String? @default("#16a34a")

  // Unit preferences (for display throughout app, except farm layout)
  weightUnit String @default("oz") // oz, g, lb, kg
  lengthUnit String @default("in") // in, ft, cm, m

  // Contact Information (for document headers)
  phone   String?
  email   String?
  website String?

  // Business Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String @default("US")

  // Document Settings
  invoicePrefix      String @default("INV")
  nextInvoiceNumber  Int    @default(1)
  invoiceFooterNotes String?

  // Relations to all tenant-scoped data
  users              FarmUser[]
  zones              Zone[]
  farmLayout         FarmLayout?
  layoutElements     LayoutElement[]
  elementPresets     ElementPreset[]
  userPreferences    UserPreference[]
  machines           Machine[]
  employees          Employee[]
  products           Product[]
  productCategories  ProductCategory[]
  packageTypes       PackageType[]
  inventoryItems     InventoryItem[]
  orders             Order[]
  customers          Customer[]
  customerTags       CustomerTag[]
  financialAccounts  FinancialAccount[]
  transactions       FinancialTransaction[]
  budgets            Budget[]
  wikiSpaces         WikiSpace[]
  wikiTags           WikiTag[]
  seasons            Season[]
  tasks              Task[]
  paymentSettings    PaymentSettings?
  payments           Payment[]
  rackAssignments    RackAssignment[]
  recurringSchedules RecurringOrderSchedule[]
  blends             Blend[]
  deliveryRoutes     DeliveryRoute[]
  generatedDocuments GeneratedDocument[]
  csaPrograms        CsaProgram[]

  // Supplies Inventory
  supplyCategories SupplyCategory[]
  supplies         Supply[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, slug])
  @@index([companyId])
}

model User {
  id         String  @id @default(cuid())
  externalId String  @unique // Clerk user ID
  email      String  @unique
  name       String?
  avatarUrl  String?

  farms          FarmUser[]
  companyAdminOf Company[]  @relation("CompanyAdmins")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FarmUser {
  id     String   @id @default(cuid())
  userId String
  farmId String
  role   FarmRole @default(FARM_OPERATOR)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  employee Employee?

  createdAt DateTime @default(now())

  @@unique([userId, farmId])
  @@index([farmId])
}

enum FarmRole {
  OWNER
  ADMIN
  FARM_MANAGER
  SALESPERSON
  FARM_OPERATOR
}

// ============================================================================
// FARM VISUALIZATION
// ============================================================================

model FarmLayout {
  id     String @id @default(cuid())
  farmId String @unique
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)

  canvasData Json // { width, height, backgroundColor, gridSize, zoom, offsetX, offsetY }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// LAYOUT ELEMENTS (Walls, Equipment, Furniture)
// ============================================================================

model LayoutElement {
  id     String      @id @default(cuid())
  farmId String
  farm   Farm        @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name   String
  type   ElementType

  // Line geometry (walls)
  startX    Float?
  startY    Float?
  endX      Float?
  endY      Float?
  thickness Float?

  // Rectangle geometry
  positionX Float?
  positionY Float?
  width     Float?
  height    Float?
  rotation  Float @default(0)

  // Appearance
  color   String @default("#666666")
  opacity Float  @default(1)

  // Preset reference
  presetId String?
  preset   ElementPreset? @relation(fields: [presetId], references: [id])

  // Flexible metadata
  metadata Json?

  // Rack assignments (for GROW_RACK elements)
  rackAssignments RackAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId])
}

enum ElementType {
  WALL
  SINK
  TABLE
  GROW_RACK
  WALKWAY
  CIRCLE
  CUSTOM
}

// ============================================================================
// RACK ASSIGNMENTS (Production Tracking)
// ============================================================================

model RackAssignment {
  id            String    @id @default(cuid())
  farmId        String
  farm          Farm      @relation(fields: [farmId], references: [id], onDelete: Cascade)

  // The grow rack element this assignment is for
  rackElementId String
  rackElement   LayoutElement @relation(fields: [rackElementId], references: [id], onDelete: Cascade)

  level         Int       // 1-based level within rack (1 = bottom, n = top)

  // What's being grown
  orderItemId   String
  orderItem     OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  trayCount     Int       // Number of trays on this rack/level
  assignedAt    DateTime  @default(now())
  assignedBy    String?   // Name of person who assigned

  // The MOVE_TO_LIGHT task that created this assignment
  taskId        String?   @unique
  task          Task?     @relation(fields: [taskId], references: [id])

  isActive      Boolean   @default(true)
  removedAt     DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([farmId])
  @@index([rackElementId, level])
  @@index([orderItemId])
}

model ElementPreset {
  id     String      @id @default(cuid())
  farmId String
  farm   Farm        @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name   String
  type   ElementType

  // Default dimensions (stored in base unit - centimeters)
  defaultWidth     Float?
  defaultHeight    Float?
  defaultThickness Float?

  // Appearance defaults
  defaultColor String  @default("#666666")
  icon         String?

  // Custom metadata (e.g., levels, traysPerLevel for grow racks)
  metadata Json?

  elements LayoutElement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, name])
  @@index([farmId])
}

model UserPreference {
  id     String @id @default(cuid())
  userId String
  farmId String
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)

  // Tutorial state
  hasSeenLayoutTutorial Boolean @default(false)

  // Unit preferences
  preferredUnit UnitSystem @default(FEET)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, farmId])
  @@index([userId])
  @@index([farmId])
}

enum UnitSystem {
  FEET
  METERS
}

model Zone {
  id     String   @id @default(cuid())
  farmId String
  farm   Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name   String
  type   ZoneType
  color  String   @default("#4CAF50")

  // Canvas positioning
  positionX Float?
  positionY Float?
  width     Float?
  height    Float?

  // Metadata
  area     Float?
  soilType String?
  notes    String?

  machines    ZoneMachine[]
  outputs     ZoneOutput[]
  cropPlans   CropPlan[]
  assignments TaskAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId])
}

enum ZoneType {
  FIELD
  GREENHOUSE
  STORAGE
  PROCESSING
  EQUIPMENT
  OFFICE
  OTHER
}

model Machine {
  id           String    @id @default(cuid())
  farmId       String
  farm         Farm      @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name         String
  type         String
  model        String?
  serialNumber String?
  purchaseDate DateTime?

  lastMaintenance DateTime?
  nextMaintenance DateTime?

  zones ZoneMachine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId])
}

model ZoneMachine {
  id        String @id @default(cuid())
  zoneId    String
  machineId String

  zone    Zone    @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  positionX Float?
  positionY Float?

  @@unique([zoneId, machineId])
}

// ============================================================================
// ZONE OUTPUT TRACKING
// ============================================================================

model ZoneOutput {
  id        String   @id @default(cuid())
  zoneId    String
  zone      Zone     @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  date      DateTime
  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  quantity Float
  unit     String
  quality  String?
  notes    String?

  createdAt DateTime @default(now())

  @@index([zoneId, date])
}

// ============================================================================
// INVENTORY MANAGEMENT
// ============================================================================

model ProductCategory {
  id       String            @id @default(cuid())
  farmId   String
  farm     Farm              @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name     String
  parentId String?
  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ProductCategory[] @relation("CategoryHierarchy")
  products Product[]

  @@unique([farmId, name])
  @@index([farmId])
}

model Product {
  id         String           @id @default(cuid())
  farmId     String
  farm       Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name       String
  sku        String?
  categoryId String?
  category   ProductCategory? @relation(fields: [categoryId], references: [id])

  seedWeight Float?
  seedUnit   String?

  // Microgreen production fields
  daysSoaking     Int?   // Days seeds soak before planting
  daysGermination Int?   // Days in germination (dark/humidity dome)
  daysLight       Int?   // Days under grow lights
  avgYieldPerTray Float? // Average yield per tray in ounces

  unitCost  Float?
  unitPrice Float?

  // Blend support
  isBlend          Boolean @default(false)  // True if this product is a blend
  blend            Blend?                    // If isBlend, links to blend definition

  // When used as an ingredient in blends
  blendIngredients BlendIngredient[] @relation("IngredientProduct")
  ingredientYields BlendIngredientYield[] @relation("IngredientYields")

  inventoryItems      InventoryItem[]
  zoneOutputs         ZoneOutput[]
  orderItems          OrderItem[]
  skus                Sku[]
  recurringOrderItems RecurringOrderItem[]

  // CSA relations
  csaMemberPreferences CsaMemberPreference[]
  csaWeekAllocations   CsaWeekAllocation[]

  // Supplies: Link to seed supply for auto-tracking
  seedSupplies Supply[] @relation("SeedProduct")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, sku])
  @@index([farmId])
}

// ============================================================================
// SKU (Stock Keeping Unit) - Sized Product Variants
// ============================================================================

enum SkuSalesChannel {
  WHOLESALE   // Sold to distributors, restaurants, stores
  RETAIL      // Sold directly to consumers
  BOTH        // Available for both channels
}

// Custom package types per farm
model PackageType {
  id        String  @id @default(cuid())
  farmId    String
  farm      Farm    @relation(fields: [farmId], references: [id], onDelete: Cascade)

  name      String  // e.g., "Clamshell", "Bag", "Bulk"
  code      String  // e.g., "CL", "BG", "BK" - used in SKU code generation

  isActive  Boolean @default(true)

  skus      Sku[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, name])
  @@unique([farmId, code])
  @@index([farmId])
}

model Sku {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  skuCode    String  // e.g., "ARU-4OZ", "ARU-3LB"
  name       String  // Display name: "4oz Arugula", "3lb Arugula"
  weightOz   Float   // Weight value (name kept for backward compatibility)
  weightUnit String  @default("oz") // Unit of measurement: oz, lb, g, kg

  price     Int     // Price in cents (500 = $5.00)

  isAvailable       Boolean @default(true)
  stockQuantity     Int?    // Optional inventory tracking
  lowStockThreshold Int?
  displayOrder      Int     @default(0)
  isPublic          Boolean @default(true)
  imageUrl          String? // SKU product image

  // Sales channel and packaging
  salesChannel  SkuSalesChannel @default(BOTH)  // Wholesale, Retail, or Both
  packageTypeId String?
  packageType   PackageType?    @relation(fields: [packageTypeId], references: [id])

  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, skuCode])
  @@index([productId])
  @@index([salesChannel])
  @@index([packageTypeId])
}

model InventoryItem {
  id        String   @id @default(cuid())
  farmId    String
  farm      Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Float
  unit      String
  location  String?

  expiryDate DateTime?
  lotNumber  String?

  reorderPoint Float?
  reorderQty   Float?

  transactions InventoryTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId])
  @@index([productId])
}

model InventoryTransaction {
  id              String        @id @default(cuid())
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  type        InventoryTxType
  quantity    Float
  previousQty Float
  newQty      Float

  reason      String?
  reference   String?
  performedBy String?

  createdAt DateTime @default(now())

  @@index([inventoryItemId, createdAt])
}

enum InventoryTxType {
  PURCHASE
  SALE
  ADJUSTMENT
  TRANSFER
  WASTE
  HARVEST
  PLANTING
}

// ============================================================================
// CUSTOMER MANAGEMENT (CRM)
// ============================================================================

model Customer {
  id     String @id @default(cuid())
  farmId String
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)

  // Contact Information
  name        String
  email       String?
  phone       String?
  companyName String?

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String @default("US")

  // Payment Terms
  paymentTerms   String @default("DUE_ON_RECEIPT") // DUE_ON_RECEIPT, NET_7, NET_15, NET_30, NET_60
  creditLimit    Float? // Maximum credit in dollars
  accountBalance Float  @default(0) // Current balance owed

  // Categorization
  customerType String       @default("RETAIL") // RETAIL, WHOLESALE, RESTAURANT, FARMERS_MARKET, DISTRIBUTOR, OTHER
  tags         CustomerTag[]
  notes        String?

  // Status
  isActive Boolean @default(true)

  // Relations
  orders             Order[]
  recurringSchedules RecurringOrderSchedule[]
  csaMemberships     CsaMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, email])
  @@index([farmId])
  @@index([farmId, name])
}

model CustomerTag {
  id     String @id @default(cuid())
  farmId String
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)

  name      String
  color     String     @default("#3b82f6")
  customers Customer[]

  @@unique([farmId, name])
  @@index([farmId])
}

// ============================================================================
// ORDER MANAGEMENT (Microgreen Production)
// ============================================================================

model Order {
  id          String      @id @default(cuid())
  farmId      String
  farm        Farm        @relation(fields: [farmId], references: [id], onDelete: Cascade)

  orderNumber String      // e.g., "ORD-2025-001"
  customerName String?    // Legacy: customer name string (kept for backward compat)
  customerId   String?    // New: link to Customer entity
  customer     Customer?  @relation(fields: [customerId], references: [id])
  status      OrderStatus @default(PENDING)
  notes       String?

  // Order source tracking
  orderSource String @default("INTERNAL") // INTERNAL, STOREFRONT, API, RECURRING

  // Payment tracking
  paymentStatus String?   // UNPAID, PAID, REFUNDED
  paymentType   PaymentType @default(INVOICE)

  // Fulfillment tracking
  fulfillmentMethod FulfillmentMethod @default(CUSTOMER_PICKUP)
  fulfillmentStatus FulfillmentStatus @default(PENDING)

  // Delivery information
  deliveryDate      DateTime?
  deliveryTimeSlot  String?           // e.g., "9AM-12PM"
  deliveryAddress   String?           // Override customer address
  deliveryNotes     String?
  deliveryRouteId   String?
  deliveryRoute     DeliveryRoute?    @relation(fields: [deliveryRouteId], references: [id])
  deliveryStopOrder Int?              // Position in route

  // Third-party pickup/distribution
  distributorName    String?
  distributorContact String?

  // Invoice tracking
  invoiceNumber  String?
  invoicedAt     DateTime?
  invoiceDueDate DateTime?

  // Recurring order tracking
  recurringScheduleId  String?
  recurringSchedule    RecurringOrderSchedule? @relation(fields: [recurringScheduleId], references: [id])
  isAutoGenerated      Boolean @default(false)
  scheduledHarvestDate DateTime?  // The target date from the schedule

  items             OrderItem[]
  payments          Payment[]
  deliverySignature DeliverySignature?
  documents         GeneratedDocument[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, orderNumber])
  @@index([farmId, status])
  @@index([farmId, customerId])
  @@index([recurringScheduleId])
  @@index([deliveryRouteId])
}

enum OrderStatus {
  PENDING
  IN_PROGRESS
  READY
  DELIVERED
  CANCELLED
}

enum FulfillmentMethod {
  FARM_DELIVERY      // Farm's own drivers deliver
  CUSTOMER_PICKUP    // Customer picks up at farm
  THIRD_PARTY_PICKUP // Distributor/grocery picks up
  SHIPPING           // Ship via carrier
  CSA_PICKUP         // CSA member pickup location
  CSA_DELIVERY       // CSA member home delivery
  FARMERS_MARKET     // Sold at farmer's market
}

enum FulfillmentStatus {
  PENDING           // Not yet ready
  READY_FOR_PICKUP  // Ready, awaiting pickup
  OUT_FOR_DELIVERY  // On delivery route
  DELIVERED         // Completed
  PICKED_UP         // Customer/distributor picked up
  FAILED            // Delivery failed
}

enum PaymentType {
  PREPAID      // Already paid (CSA, online order)
  INVOICE      // Bill customer later
  COD          // Collect on delivery
  SUBSCRIPTION // Recurring subscription payment
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])

  // Optional SKU reference (for storefront orders)
  skuId String?
  sku   Sku?    @relation(fields: [skuId], references: [id])

  // Pricing (for storefront orders)
  quantity       Int?   // Quantity of SKUs ordered
  unitPriceCents Int?   // Price per unit at time of order
  lineTotalCents Int?   // Line item total

  // Order specifications (for production)
  quantityOz     Float    // Quantity ordered in ounces
  harvestDate    DateTime // Target harvest date
  overagePercent Float    @default(10) // Overage percentage (default 10%)

  // Auto-calculated fields
  traysNeeded     Int      // Calculated: ceil((quantityOz * (1 + overage%)) / avgYield)
  soakDate        DateTime // Calculated: harvestDate - daysLight - daysGermination - daysSoaking
  seedDate        DateTime // Calculated: harvestDate - daysLight - daysGermination
  moveToLightDate DateTime // Calculated: harvestDate - daysLight

  // Actual results (filled after production)
  actualYieldOz Float?
  actualTrays   Int?
  seedLot       String?   // Seed lot number for traceability (set during seeding)

  status OrderItemStatus @default(PENDING)

  tasks           Task[]
  rackAssignments RackAssignment[]

  // Blend instance (if ordering a blend product)
  blendInstance   BlendOrderInstance?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
  @@index([harvestDate])
}

enum OrderItemStatus {
  PENDING
  SOAKING
  GERMINATING
  GROWING
  HARVESTED
  CANCELLED
}

// ============================================================================
// RECURRING ORDERS
// ============================================================================

model RecurringOrderSchedule {
  id        String   @id @default(cuid())
  farmId    String
  farm      Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  name      String              // Display name: "Weekly Restaurant Order"
  customerId String?
  customer  Customer?           @relation(fields: [customerId], references: [id])

  // Schedule type
  scheduleType  RecurrenceType  // FIXED_DAY or INTERVAL

  // For FIXED_DAY: which days of week (0=Sun, 1=Mon, etc.)
  daysOfWeek    String          @default("[]") // JSON array stored as string for SQLite

  // For INTERVAL: every N days
  intervalDays  Int?            // e.g., 7 for weekly, 14 for bi-weekly

  // Schedule range
  startDate     DateTime
  endDate       DateTime?       // Optional end date

  // How far ahead to generate orders (in days)
  leadTimeDays  Int             @default(28) // Generate 4 weeks ahead

  // Template items for the recurring order
  items         RecurringOrderItem[]

  // Orders generated from this schedule
  generatedOrders Order[]

  // Dates to skip (holidays, vacations)
  skippedDates  RecurringOrderSkip[]

  isActive      Boolean         @default(true)
  notes         String?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([farmId])
  @@index([farmId, isActive])
}

enum RecurrenceType {
  FIXED_DAY   // "Every Tuesday"
  INTERVAL    // "Every 7 days"
}

model RecurringOrderItem {
  id             String   @id @default(cuid())
  scheduleId     String
  schedule       RecurringOrderSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  productId      String
  product        Product  @relation(fields: [productId], references: [id])

  quantityOz     Float
  overagePercent Float    @default(10)

  createdAt      DateTime @default(now())

  @@index([scheduleId])
}

model RecurringOrderSkip {
  id         String   @id @default(cuid())
  scheduleId String
  schedule   RecurringOrderSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  skipDate   DateTime  // The harvest date to skip
  reason     String?   // "Holiday", "Customer vacation", etc.

  createdAt  DateTime @default(now())

  @@unique([scheduleId, skipDate])
  @@index([scheduleId])
}

// ============================================================================
// BLENDS/MIXES (Composite Products)
// ============================================================================

model Blend {
  id          String   @id @default(cuid())
  farmId      String
  farm        Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  name        String              // "Spicy Mix", "Spring Blend"
  description String?

  // A blend IS a product (for pricing, SKUs, ordering)
  productId   String   @unique
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Component ingredients with ratios
  ingredients BlendIngredient[]

  // Track actual production of blends per order item
  blendInstances BlendOrderInstance[]

  isActive    Boolean @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([farmId, name])
  @@index([farmId])
}

model BlendIngredient {
  id           String  @id @default(cuid())
  blendId      String
  blend        Blend   @relation(fields: [blendId], references: [id], onDelete: Cascade)

  // The base product (individual microgreen variety)
  productId    String
  product      Product @relation("IngredientProduct", fields: [productId], references: [id])

  // Ratio as percentage (all ingredients should sum to 100%)
  ratioPercent Float   // e.g., 33.3 for 1/3 of the blend

  // Optional: override production timing for this ingredient in this blend
  overrideDaysSoaking     Int?
  overrideDaysGermination Int?
  overrideDaysLight       Int?

  displayOrder Int @default(0)

  @@unique([blendId, productId])
  @@index([blendId])
}

// Tracks actual production of blends per order item
model BlendOrderInstance {
  id          String    @id @default(cuid())
  blendId     String
  blend       Blend     @relation(fields: [blendId], references: [id])
  orderItemId String    @unique
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  // Calculated target quantities per ingredient (stored as JSON)
  ingredientTargets String  @default("[]") // JSON: [{ productId, targetOz, traysNeeded }]

  // Actual yields recorded per ingredient
  ingredientYields BlendIngredientYield[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([blendId])
  @@index([orderItemId])
}

model BlendIngredientYield {
  id                 String   @id @default(cuid())
  blendInstanceId    String
  blendInstance      BlendOrderInstance @relation(fields: [blendInstanceId], references: [id], onDelete: Cascade)

  productId          String
  product            Product  @relation("IngredientYields", fields: [productId], references: [id])

  targetOz           Float
  actualYieldOz      Float?
  traysUsed          Int?
  harvestedAt        DateTime?
  harvestedBy        String?
  notes              String?

  @@unique([blendInstanceId, productId])
  @@index([blendInstanceId])
}

// ============================================================================
// EMPLOYEE MANAGEMENT
// ============================================================================

model Employee {
  id         String  @id @default(cuid())
  farmId     String
  farm       Farm    @relation(fields: [farmId], references: [id], onDelete: Cascade)
  farmUserId String? @unique
  farmUser   FarmUser? @relation(fields: [farmUserId], references: [id])

  firstName  String
  lastName   String
  email      String?
  phone      String?
  position   EmployeePosition?
  department String?
  hireDate   DateTime?
  hourlyRate Float?

  status EmployeeStatus @default(ACTIVE)

  // Invitation system for account creation
  inviteToken     String?       @unique
  inviteStatus    InviteStatus  @default(NOT_INVITED)
  inviteExpiresAt DateTime?
  invitedAt       DateTime?
  acceptedAt      DateTime?

  shifts      Shift[]
  timeEntries TimeEntry[]
  assignments TaskAssignment[]
  deliveryRoutes DeliveryRoute[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId])
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
}

enum EmployeePosition {
  ADMIN
  FARM_MANAGER
  SALESPERSON
  FARM_OPERATOR
  DRIVER
}

enum InviteStatus {
  NOT_INVITED  // No invite sent yet
  PENDING      // Invite sent, awaiting response
  ACCEPTED     // User created account
  EXPIRED      // Token expired
  REVOKED      // Admin cancelled invite
}

model Shift {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  date      DateTime
  startTime DateTime
  endTime   DateTime
  breakMins Int      @default(0)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId, date])
}

model TimeEntry {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  clockIn    DateTime
  clockOut   DateTime?
  breakMins  Int       @default(0)
  totalHours Float?

  notes      String?
  approved   Boolean @default(false)
  approvedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId, clockIn])
}

// ============================================================================
// FINANCIAL PROJECTIONS
// ============================================================================

model FinancialAccount {
  id       String      @id @default(cuid())
  farmId   String
  farm     Farm        @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name     String
  type     AccountType
  code     String?
  parentId String?

  transactions FinancialTransaction[]
  budgetItems  BudgetItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, code])
  @@index([farmId])
}

enum AccountType {
  REVENUE
  EXPENSE
  ASSET
  LIABILITY
}

model FinancialTransaction {
  id        String           @id @default(cuid())
  farmId    String
  farm      Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)
  accountId String
  account   FinancialAccount @relation(fields: [accountId], references: [id])

  date   DateTime
  amount Float
  type   TransactionType

  description String?
  reference   String?
  category    String?

  zoneId    String?
  productId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId, date])
  @@index([accountId])
}

enum TransactionType {
  INCOME
  EXPENSE
}

model Budget {
  id     String       @id @default(cuid())
  farmId String
  farm   Farm         @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name   String
  year   Int
  status BudgetStatus @default(DRAFT)

  items BudgetItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, year, name])
  @@index([farmId])
}

enum BudgetStatus {
  DRAFT
  APPROVED
  CLOSED
}

model BudgetItem {
  id        String           @id @default(cuid())
  budgetId  String
  budget    Budget           @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  accountId String
  account   FinancialAccount @relation(fields: [accountId], references: [id])

  jan Float @default(0)
  feb Float @default(0)
  mar Float @default(0)
  apr Float @default(0)
  may Float @default(0)
  jun Float @default(0)
  jul Float @default(0)
  aug Float @default(0)
  sep Float @default(0)
  oct Float @default(0)
  nov Float @default(0)
  dec Float @default(0)

  notes String?

  @@unique([budgetId, accountId])
}

// ============================================================================
// SOPs & INTERNAL WIKI
// ============================================================================

model WikiSpace {
  id     String @id @default(cuid())
  farmId String
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)

  name String
  slug String
  icon String?

  pages WikiPage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, slug])
  @@index([farmId])
}

model WikiPage {
  id      String    @id @default(cuid())
  spaceId String
  space   WikiSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  title   String
  slug    String
  content Json // TipTap JSON format

  parentId String?
  parent   WikiPage?  @relation("PageHierarchy", fields: [parentId], references: [id])
  children WikiPage[] @relation("PageHierarchy")

  author    String
  published Boolean @default(false)

  revisions WikiRevision[]
  tags      WikiTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([spaceId, slug])
  @@index([spaceId])
}

model WikiRevision {
  id     String   @id @default(cuid())
  pageId String
  page   WikiPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  content Json
  author  String
  comment String?

  createdAt DateTime @default(now())

  @@index([pageId, createdAt])
}

model WikiTag {
  id     String @id @default(cuid())
  farmId String
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name   String

  pages WikiPage[]

  @@unique([farmId, name])
  @@index([farmId])
}

// ============================================================================
// FARM PLANNING
// ============================================================================

model Season {
  id     String @id @default(cuid())
  farmId String
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)

  name      String
  year      Int
  startDate DateTime
  endDate   DateTime

  status SeasonStatus @default(PLANNING)

  cropPlans CropPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId, year])
}

enum SeasonStatus {
  PLANNING
  ACTIVE
  COMPLETED
}

model CropPlan {
  id       String @id @default(cuid())
  seasonId String
  season   Season @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  zoneId   String
  zone     Zone   @relation(fields: [zoneId], references: [id])

  cropName String
  variety  String?

  seedDate       DateTime?
  transplantDate DateTime?
  harvestStart   DateTime?
  harvestEnd     DateTime?

  targetYield Float?
  targetUnit  String?
  actualYield Float?

  notes String?

  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seasonId])
  @@index([zoneId])
}

model Task {
  id          String @id @default(cuid())
  farmId      String
  farm        Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)
  title       String
  description String?

  type TaskType

  dueDate   DateTime?
  startDate DateTime?

  status   TaskStatus   @default(TODO)
  priority TaskPriority @default(MEDIUM)

  // Link to order item (for microgreen production tasks)
  orderItemId String?
  orderItem   OrderItem? @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  // Legacy: Keep cropPlanId for backward compatibility
  cropPlanId String?
  cropPlan   CropPlan? @relation(fields: [cropPlanId], references: [id])

  assignments TaskAssignment[]

  recurrence Json?

  // Completion log fields
  completedAt     DateTime?
  completedBy     String?   // Name of person who completed it
  completionNotes String?   // Notes from completion
  actualTrays     Int?      // Actual trays processed (may differ from expected)
  seedLot         String?   // Seed lot number for traceability

  // Rack assignment created when MOVE_TO_LIGHT task is completed
  rackAssignment RackAssignment?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId, status])
  @@index([farmId, dueDate])
  @@index([orderItemId])
}

enum TaskType {
  // Microgreen production tasks
  SOAK
  SEED
  MOVE_TO_LIGHT
  HARVESTING

  // General farm tasks
  PLANTING
  WATERING
  FERTILIZING
  MAINTENANCE
  INSPECTION
  OTHER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model TaskAssignment {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id])
  zoneId     String?
  zone       Zone?     @relation(fields: [zoneId], references: [id])

  createdAt DateTime @default(now())

  @@index([taskId])
  @@index([employeeId])
}

// ============================================================================
// PAYMENTS
// ============================================================================

model PaymentSettings {
  id                    String  @id @default(cuid())
  farmId                String  @unique
  farm                  Farm    @relation(fields: [farmId], references: [id], onDelete: Cascade)

  // Stripe Connect
  stripeAccountId          String?
  stripeAccountStatus      String  @default("NOT_CONNECTED") // NOT_CONNECTED, PENDING, ACTIVE, RESTRICTED
  stripeOnboardingComplete Boolean @default(false)

  // PayPal Commerce Platform
  paypalMerchantId      String?
  paypalClientId        String?
  paypalAccountStatus   String  @default("NOT_CONNECTED")

  // Settings
  preferredProcessor    String  @default("STRIPE") // STRIPE or PAYPAL
  paymentTiming         String  @default("UPFRONT") // UPFRONT or ON_READY
  platformFeePercent    Float   @default(2.5)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Payment {
  id                    String    @id @default(cuid())
  farmId                String
  farm                  Farm      @relation(fields: [farmId], references: [id], onDelete: Cascade)
  orderId               String?
  order                 Order?    @relation(fields: [orderId], references: [id])

  amount                Float
  currency              String    @default("usd")
  status                String    @default("PENDING") // PENDING, PROCESSING, SUCCEEDED, FAILED, REFUNDED, PARTIALLY_REFUNDED, CANCELLED
  processor             String    @default("STRIPE") // STRIPE or PAYPAL
  platformFee           Int?      // Platform fee in cents

  // Stripe-specific fields
  stripePaymentIntentId String?
  stripePaymentLinkId   String?

  // PayPal-specific fields
  paypalOrderId         String?

  // Payment link fields
  paymentLinkId         String?   @unique
  paymentLinkUrl        String?
  paymentLinkExpiresAt  DateTime?

  customerEmail         String?
  customerName          String?
  description           String?

  // Result fields
  paidAt                DateTime?
  failureReason         String?
  refundedAmount        Float?
  refundedAt            DateTime?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([farmId])
  @@index([orderId])
  @@index([stripePaymentIntentId])
  @@index([paypalOrderId])
}

model StripeWebhookEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  eventType     String
  processed     Boolean  @default(false)
  error         String?
  createdAt     DateTime @default(now())
}

// ============================================================================
// DELIVERY & FULFILLMENT
// ============================================================================

model DeliveryRoute {
  id        String   @id @default(cuid())
  farmId    String
  farm      Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  name      String              // e.g., "Monday Downtown Route"
  date      DateTime            // The date of this route

  driverId  String?
  driver    Employee? @relation(fields: [driverId], references: [id])

  status    RouteStatus @default(PLANNED)

  // Route metrics
  estimatedDuration Int?        // Minutes
  estimatedMiles    Float?
  actualDuration    Int?
  actualMiles       Float?

  startedAt   DateTime?
  completedAt DateTime?

  orders      Order[]
  notes       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([farmId, date])
  @@index([driverId])
}

enum RouteStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model DeliverySignature {
  id        String   @id @default(cuid())
  orderId   String   @unique
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  signatureData  String      // Base64 encoded signature image
  signedBy       String      // Name of person who signed
  signedAt       DateTime    @default(now())

  // GPS location at time of signature (optional)
  latitude   Float?
  longitude  Float?

  // Photo proof (optional)
  photoUrl   String?

  capturedBy String?         // Driver who captured signature

  createdAt  DateTime @default(now())
}

// ============================================================================
// DOCUMENT GENERATION
// ============================================================================

model GeneratedDocument {
  id        String   @id @default(cuid())
  farmId    String
  farm      Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  orderId   String?
  order     Order?   @relation(fields: [orderId], references: [id])

  type           DocumentType
  documentNumber String       // INV-2025-001, PS-2025-001, etc.

  fileUrl     String          // Path to generated PDF
  fileName    String

  generatedAt DateTime @default(now())
  generatedBy String?         // User who generated it

  // For invoices
  dueDate     DateTime?
  sentAt      DateTime?
  sentTo      String?          // Email address

  createdAt   DateTime @default(now())

  @@index([farmId, type])
  @@index([orderId])
}

enum DocumentType {
  PACKING_SLIP
  INVOICE
  DELIVERY_RECEIPT
  BILL_OF_LADING
}

// ============================================================================
// CSA (COMMUNITY SUPPORTED AGRICULTURE)
// ============================================================================

model CsaProgram {
  id          String   @id @default(cuid())
  farmId      String
  farm        Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  name        String              // "2025 Spring CSA"
  description String?

  // Season dates
  startDate   DateTime
  endDate     DateTime

  // Pickup/delivery settings
  pickupDay       Int?         // 0=Sunday, 1=Monday, etc.
  pickupTimeStart String?      // "10:00"
  pickupTimeEnd   String?      // "14:00"

  status      CsaProgramStatus @default(DRAFT)

  shareTypes      CsaShareType[]
  members         CsaMember[]
  weeks           CsaWeek[]
  pickupLocations CsaPickupLocation[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([farmId])
  @@index([farmId, status])
}

enum CsaProgramStatus {
  DRAFT
  OPEN_ENROLLMENT
  ACTIVE
  COMPLETED
  CANCELLED
}

model CsaShareType {
  id          String   @id @default(cuid())
  programId   String
  program     CsaProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  name        String          // "Full Share", "Half Share"
  description String?

  price       Int             // Total price in cents for the season
  weeklyPrice Int?            // Optional weekly price for display

  // Quantity limits
  maxMembers  Int?            // Maximum members for this share type

  members         CsaMember[]
  weekAllocations CsaWeekAllocation[]

  displayOrder Int @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([programId])
}

model CsaMember {
  id          String   @id @default(cuid())
  programId   String
  program     CsaProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])

  shareTypeId String
  shareType   CsaShareType @relation(fields: [shareTypeId], references: [id])

  // Payment status
  paymentStatus CsaPaymentStatus @default(PENDING)
  paidAmount    Int @default(0)    // Amount paid in cents
  paymentNotes  String?

  // Pickup/delivery preference
  fulfillmentMethod FulfillmentMethod @default(CSA_PICKUP)
  pickupLocationId  String?
  pickupLocation    CsaPickupLocation? @relation(fields: [pickupLocationId], references: [id])

  // Member preferences
  preferences CsaMemberPreference[]

  // Skipped weeks
  skippedWeeks CsaMemberSkip[]

  status      CsaMemberStatus @default(ACTIVE)
  notes       String?

  enrolledAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([programId, customerId])
  @@index([programId])
  @@index([customerId])
}

enum CsaPaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

enum CsaMemberStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

model CsaMemberPreference {
  id        String   @id @default(cuid())
  memberId  String
  member    CsaMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id])

  preference PreferenceType
  notes      String?

  @@unique([memberId, productId])
  @@index([memberId])
}

enum PreferenceType {
  LOVE          // Extra if available
  LIKE          // Normal amount
  DISLIKE       // Less or none
  ALLERGY       // Never include
}

model CsaMemberSkip {
  id        String   @id @default(cuid())
  memberId  String
  member    CsaMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  weekId    String
  week      CsaWeek  @relation(fields: [weekId], references: [id])

  reason    String?

  createdAt DateTime @default(now())

  @@unique([memberId, weekId])
}

model CsaPickupLocation {
  id          String   @id @default(cuid())
  programId   String
  program     CsaProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  name        String          // "Downtown Pickup"
  address     String

  pickupDay       Int?        // Override program default
  pickupTimeStart String?
  pickupTimeEnd   String?

  contactName  String?
  contactPhone String?

  notes       String?
  isActive    Boolean @default(true)

  members     CsaMember[]

  @@index([programId])
}

model CsaWeek {
  id          String   @id @default(cuid())
  programId   String
  program     CsaProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  weekNumber  Int             // 1, 2, 3, etc.
  weekDate    DateTime        // The pickup/delivery date

  status      CsaWeekStatus @default(PLANNING)

  allocations  CsaWeekAllocation[]
  skipRequests CsaMemberSkip[]

  notes       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([programId, weekNumber])
  @@index([programId])
}

enum CsaWeekStatus {
  PLANNING      // Still planning contents
  FINALIZED     // Contents locked
  DISTRIBUTED   // Boxes distributed
}

model CsaWeekAllocation {
  id          String   @id @default(cuid())
  weekId      String
  week        CsaWeek  @relation(fields: [weekId], references: [id], onDelete: Cascade)

  shareTypeId String
  shareType   CsaShareType @relation(fields: [shareTypeId], references: [id])

  productId   String
  product     Product  @relation(fields: [productId], references: [id])

  quantityOz  Float           // Amount in ounces

  @@unique([weekId, shareTypeId, productId])
  @@index([weekId])
}

// ============================================================================
// SUPPLIES INVENTORY (Seeds, Grow Media, etc.)
// ============================================================================

model SupplyCategory {
  id        String   @id @default(cuid())
  farmId    String
  farm      Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  name      String   // "Seeds", "Grow Media", "Packaging", "Nutrients", etc.
  sortOrder Int      @default(0)

  supplies  Supply[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, name])
  @@index([farmId])
}

model Supply {
  id         String         @id @default(cuid())
  farmId     String
  farm       Farm           @relation(fields: [farmId], references: [id], onDelete: Cascade)
  categoryId String
  category   SupplyCategory @relation(fields: [categoryId], references: [id])

  name String  // "Sunflower Seeds", "BioStrate Sheets", etc.
  sku  String? // Optional internal SKU

  // For seeds - link to variety
  productId String?  // Links to Product (variety) for seeds
  product   Product? @relation("SeedProduct", fields: [productId], references: [id])

  // Inventory tracking
  unit         String?           // Base unit for this supply (g, lb, sheets, etc.)
  currentStock Decimal @default(0) // Current inventory level

  isActive Boolean @default(true)

  purchases SupplyPurchase[]
  usageLogs SupplyUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, name])
  @@index([farmId])
  @@index([categoryId])
  @@index([productId])
}

model SupplyPurchase {
  id       String @id @default(cuid())
  supplyId String
  supply   Supply @relation(fields: [supplyId], references: [id], onDelete: Cascade)

  quantity  Decimal // Amount received
  unit      String  // "g", "oz", "lb", "sheets", "bags", etc.
  unitCost  Int     // Cost per unit in cents
  totalCost Int     // Total cost in cents

  supplier     String? // Supplier name
  lotNumber    String? // Lot/batch number for traceability
  purchaseDate DateTime @default(now())
  expiryDate   DateTime?
  notes        String?

  receivedBy String? // Who received it

  createdAt DateTime @default(now())

  @@index([supplyId])
  @@index([lotNumber])
}

model SupplyUsage {
  id       String @id @default(cuid())
  supplyId String
  supply   Supply @relation(fields: [supplyId], references: [id], onDelete: Cascade)

  quantity  Decimal // Amount used
  usageType String  // "PRODUCTION", "ADJUSTMENT", "WASTE", "OTHER"

  // Link to production (optional)
  taskId      String? // Links to Task (SEED task)
  orderItemId String? // Links to OrderItem

  lotNumber  String? // Which lot was used
  notes      String?
  recordedBy String?
  usageDate  DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([supplyId])
  @@index([taskId])
  @@index([usageDate])
}
