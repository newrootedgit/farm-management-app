generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ============================================================================
// MULTI-TENANCY & AUTH
// ============================================================================

model Company {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  farms     Farm[]
  admins    User[]   @relation("CompanyAdmins")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Farm {
  id        String   @id @default(cuid())
  name      String
  slug      String
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  timezone String @default("UTC")
  currency String @default("USD")

  // Branding
  logoUrl    String?
  brandColor String? @default("#16a34a")

  // Unit preferences (for display throughout app, except farm layout)
  weightUnit String @default("oz") // oz, g, lb, kg
  lengthUnit String @default("in") // in, ft, cm, m

  // Relations to all tenant-scoped data
  users              FarmUser[]
  zones              Zone[]
  farmLayout         FarmLayout?
  layoutElements     LayoutElement[]
  elementPresets     ElementPreset[]
  userPreferences    UserPreference[]
  machines           Machine[]
  employees          Employee[]
  products           Product[]
  productCategories  ProductCategory[]
  inventoryItems     InventoryItem[]
  orders             Order[]
  customers          Customer[]
  customerTags       CustomerTag[]
  financialAccounts  FinancialAccount[]
  transactions       FinancialTransaction[]
  budgets            Budget[]
  wikiSpaces         WikiSpace[]
  wikiTags           WikiTag[]
  seasons            Season[]
  tasks              Task[]
  paymentSettings    PaymentSettings?
  payments           Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, slug])
  @@index([companyId])
}

model User {
  id         String  @id @default(cuid())
  externalId String  @unique // Clerk user ID
  email      String  @unique
  name       String?
  avatarUrl  String?

  farms          FarmUser[]
  companyAdminOf Company[]  @relation("CompanyAdmins")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FarmUser {
  id     String   @id @default(cuid())
  userId String
  farmId String
  role   FarmRole @default(FARM_OPERATOR)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  employee Employee?

  createdAt DateTime @default(now())

  @@unique([userId, farmId])
  @@index([farmId])
}

enum FarmRole {
  OWNER
  ADMIN
  FARM_MANAGER
  SALESPERSON
  FARM_OPERATOR
}

// ============================================================================
// FARM VISUALIZATION
// ============================================================================

model FarmLayout {
  id     String @id @default(cuid())
  farmId String @unique
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)

  canvasData Json // { width, height, backgroundColor, gridSize, zoom, offsetX, offsetY }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// LAYOUT ELEMENTS (Walls, Equipment, Furniture)
// ============================================================================

model LayoutElement {
  id     String      @id @default(cuid())
  farmId String
  farm   Farm        @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name   String
  type   ElementType

  // Line geometry (walls)
  startX    Float?
  startY    Float?
  endX      Float?
  endY      Float?
  thickness Float?

  // Rectangle geometry
  positionX Float?
  positionY Float?
  width     Float?
  height    Float?
  rotation  Float @default(0)

  // Appearance
  color   String @default("#666666")
  opacity Float  @default(1)

  // Preset reference
  presetId String?
  preset   ElementPreset? @relation(fields: [presetId], references: [id])

  // Flexible metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId])
}

enum ElementType {
  WALL
  SINK
  TABLE
  GROW_RACK
  CUSTOM
}

model ElementPreset {
  id     String      @id @default(cuid())
  farmId String
  farm   Farm        @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name   String
  type   ElementType

  // Default dimensions (stored in base unit - centimeters)
  defaultWidth     Float?
  defaultHeight    Float?
  defaultThickness Float?

  // Appearance defaults
  defaultColor String  @default("#666666")
  icon         String?

  elements LayoutElement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, name])
  @@index([farmId])
}

model UserPreference {
  id     String @id @default(cuid())
  userId String
  farmId String
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)

  // Tutorial state
  hasSeenLayoutTutorial Boolean @default(false)

  // Unit preferences
  preferredUnit UnitSystem @default(FEET)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, farmId])
  @@index([userId])
  @@index([farmId])
}

enum UnitSystem {
  FEET
  METERS
}

model Zone {
  id     String   @id @default(cuid())
  farmId String
  farm   Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name   String
  type   ZoneType
  color  String   @default("#4CAF50")

  // Canvas positioning
  positionX Float?
  positionY Float?
  width     Float?
  height    Float?

  // Metadata
  area     Float?
  soilType String?
  notes    String?

  machines    ZoneMachine[]
  outputs     ZoneOutput[]
  cropPlans   CropPlan[]
  assignments TaskAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId])
}

enum ZoneType {
  FIELD
  GREENHOUSE
  STORAGE
  PROCESSING
  EQUIPMENT
  OFFICE
  OTHER
}

model Machine {
  id           String    @id @default(cuid())
  farmId       String
  farm         Farm      @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name         String
  type         String
  model        String?
  serialNumber String?
  purchaseDate DateTime?

  lastMaintenance DateTime?
  nextMaintenance DateTime?

  zones ZoneMachine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId])
}

model ZoneMachine {
  id        String @id @default(cuid())
  zoneId    String
  machineId String

  zone    Zone    @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  positionX Float?
  positionY Float?

  @@unique([zoneId, machineId])
}

// ============================================================================
// ZONE OUTPUT TRACKING
// ============================================================================

model ZoneOutput {
  id        String   @id @default(cuid())
  zoneId    String
  zone      Zone     @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  date      DateTime
  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  quantity Float
  unit     String
  quality  String?
  notes    String?

  createdAt DateTime @default(now())

  @@index([zoneId, date])
}

// ============================================================================
// INVENTORY MANAGEMENT
// ============================================================================

model ProductCategory {
  id       String            @id @default(cuid())
  farmId   String
  farm     Farm              @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name     String
  parentId String?
  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ProductCategory[] @relation("CategoryHierarchy")
  products Product[]

  @@unique([farmId, name])
  @@index([farmId])
}

model Product {
  id         String           @id @default(cuid())
  farmId     String
  farm       Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name       String
  sku        String?
  categoryId String?
  category   ProductCategory? @relation(fields: [categoryId], references: [id])

  seedWeight Float?
  seedUnit   String?

  // Microgreen production fields
  daysSoaking     Int?   // Days seeds soak before planting
  daysGermination Int?   // Days in germination (dark/humidity dome)
  daysLight       Int?   // Days under grow lights
  avgYieldPerTray Float? // Average yield per tray in ounces

  unitCost  Float?
  unitPrice Float?

  inventoryItems InventoryItem[]
  zoneOutputs    ZoneOutput[]
  orderItems     OrderItem[]
  skus           Sku[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, sku])
  @@index([farmId])
}

// ============================================================================
// SKU (Stock Keeping Unit) - Sized Product Variants
// ============================================================================

model Sku {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  skuCode   String  // e.g., "ARU-4OZ"
  name      String  // Display name: "4oz Arugula"
  weightOz  Float   // Weight in ounces

  price     Int     // Price in cents (500 = $5.00)

  isAvailable       Boolean @default(true)
  stockQuantity     Int?    // Optional inventory tracking
  lowStockThreshold Int?
  displayOrder      Int     @default(0)
  isPublic          Boolean @default(true)
  imageUrl          String? // SKU product image

  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, skuCode])
  @@index([productId])
}

model InventoryItem {
  id        String   @id @default(cuid())
  farmId    String
  farm      Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Float
  unit      String
  location  String?

  expiryDate DateTime?
  lotNumber  String?

  reorderPoint Float?
  reorderQty   Float?

  transactions InventoryTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId])
  @@index([productId])
}

model InventoryTransaction {
  id              String        @id @default(cuid())
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  type        InventoryTxType
  quantity    Float
  previousQty Float
  newQty      Float

  reason      String?
  reference   String?
  performedBy String?

  createdAt DateTime @default(now())

  @@index([inventoryItemId, createdAt])
}

enum InventoryTxType {
  PURCHASE
  SALE
  ADJUSTMENT
  TRANSFER
  WASTE
  HARVEST
  PLANTING
}

// ============================================================================
// CUSTOMER MANAGEMENT (CRM)
// ============================================================================

model Customer {
  id     String @id @default(cuid())
  farmId String
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)

  // Contact Information
  name        String
  email       String?
  phone       String?
  companyName String?

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String @default("US")

  // Payment Terms
  paymentTerms   String @default("DUE_ON_RECEIPT") // DUE_ON_RECEIPT, NET_7, NET_15, NET_30, NET_60
  creditLimit    Float? // Maximum credit in dollars
  accountBalance Float  @default(0) // Current balance owed

  // Categorization
  customerType String       @default("RETAIL") // RETAIL, WHOLESALE, RESTAURANT, FARMERS_MARKET, DISTRIBUTOR, OTHER
  tags         CustomerTag[]
  notes        String?

  // Status
  isActive Boolean @default(true)

  // Relations
  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, email])
  @@index([farmId])
  @@index([farmId, name])
}

model CustomerTag {
  id     String @id @default(cuid())
  farmId String
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)

  name      String
  color     String     @default("#3b82f6")
  customers Customer[]

  @@unique([farmId, name])
  @@index([farmId])
}

// ============================================================================
// ORDER MANAGEMENT (Microgreen Production)
// ============================================================================

model Order {
  id          String      @id @default(cuid())
  farmId      String
  farm        Farm        @relation(fields: [farmId], references: [id], onDelete: Cascade)

  orderNumber String      // e.g., "ORD-2025-001"
  customerName String?    // Legacy: customer name string (kept for backward compat)
  customerId   String?    // New: link to Customer entity
  customer     Customer?  @relation(fields: [customerId], references: [id])
  status      OrderStatus @default(PENDING)
  notes       String?

  // Order source tracking
  orderSource String @default("INTERNAL") // INTERNAL, STOREFRONT, API

  // Payment tracking
  paymentStatus String?   // UNPAID, PAID, REFUNDED

  items    OrderItem[]
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, orderNumber])
  @@index([farmId, status])
  @@index([farmId, customerId])
}

enum OrderStatus {
  PENDING
  IN_PROGRESS
  READY
  DELIVERED
  CANCELLED
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])

  // Optional SKU reference (for storefront orders)
  skuId String?
  sku   Sku?    @relation(fields: [skuId], references: [id])

  // Pricing (for storefront orders)
  quantity       Int?   // Quantity of SKUs ordered
  unitPriceCents Int?   // Price per unit at time of order
  lineTotalCents Int?   // Line item total

  // Order specifications (for production)
  quantityOz     Float    // Quantity ordered in ounces
  harvestDate    DateTime // Target harvest date
  overagePercent Float    @default(10) // Overage percentage (default 10%)

  // Auto-calculated fields
  traysNeeded     Int      // Calculated: ceil((quantityOz * (1 + overage%)) / avgYield)
  soakDate        DateTime // Calculated: harvestDate - daysLight - daysGermination - daysSoaking
  seedDate        DateTime // Calculated: harvestDate - daysLight - daysGermination
  moveToLightDate DateTime // Calculated: harvestDate - daysLight

  // Actual results (filled after production)
  actualYieldOz Float?
  actualTrays   Int?

  status OrderItemStatus @default(PENDING)

  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
  @@index([harvestDate])
}

enum OrderItemStatus {
  PENDING
  SOAKING
  GERMINATING
  GROWING
  HARVESTED
  CANCELLED
}

// ============================================================================
// EMPLOYEE MANAGEMENT
// ============================================================================

model Employee {
  id         String  @id @default(cuid())
  farmId     String
  farm       Farm    @relation(fields: [farmId], references: [id], onDelete: Cascade)
  farmUserId String? @unique
  farmUser   FarmUser? @relation(fields: [farmUserId], references: [id])

  firstName  String
  lastName   String
  email      String?
  phone      String?
  position   EmployeePosition?
  department String?
  hireDate   DateTime?
  hourlyRate Float?

  status EmployeeStatus @default(ACTIVE)

  // Invitation system for account creation
  inviteToken     String?       @unique
  inviteStatus    InviteStatus  @default(NOT_INVITED)
  inviteExpiresAt DateTime?
  invitedAt       DateTime?
  acceptedAt      DateTime?

  shifts      Shift[]
  timeEntries TimeEntry[]
  assignments TaskAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId])
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
}

enum EmployeePosition {
  FARM_MANAGER
  SALESPERSON
  FARM_OPERATOR
}

enum InviteStatus {
  NOT_INVITED  // No invite sent yet
  PENDING      // Invite sent, awaiting response
  ACCEPTED     // User created account
  EXPIRED      // Token expired
  REVOKED      // Admin cancelled invite
}

model Shift {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  date      DateTime
  startTime DateTime
  endTime   DateTime
  breakMins Int      @default(0)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId, date])
}

model TimeEntry {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  clockIn    DateTime
  clockOut   DateTime?
  breakMins  Int       @default(0)
  totalHours Float?

  notes      String?
  approved   Boolean @default(false)
  approvedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId, clockIn])
}

// ============================================================================
// FINANCIAL PROJECTIONS
// ============================================================================

model FinancialAccount {
  id       String      @id @default(cuid())
  farmId   String
  farm     Farm        @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name     String
  type     AccountType
  code     String?
  parentId String?

  transactions FinancialTransaction[]
  budgetItems  BudgetItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, code])
  @@index([farmId])
}

enum AccountType {
  REVENUE
  EXPENSE
  ASSET
  LIABILITY
}

model FinancialTransaction {
  id        String           @id @default(cuid())
  farmId    String
  farm      Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)
  accountId String
  account   FinancialAccount @relation(fields: [accountId], references: [id])

  date   DateTime
  amount Float
  type   TransactionType

  description String?
  reference   String?
  category    String?

  zoneId    String?
  productId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId, date])
  @@index([accountId])
}

enum TransactionType {
  INCOME
  EXPENSE
}

model Budget {
  id     String       @id @default(cuid())
  farmId String
  farm   Farm         @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name   String
  year   Int
  status BudgetStatus @default(DRAFT)

  items BudgetItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, year, name])
  @@index([farmId])
}

enum BudgetStatus {
  DRAFT
  APPROVED
  CLOSED
}

model BudgetItem {
  id        String           @id @default(cuid())
  budgetId  String
  budget    Budget           @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  accountId String
  account   FinancialAccount @relation(fields: [accountId], references: [id])

  jan Float @default(0)
  feb Float @default(0)
  mar Float @default(0)
  apr Float @default(0)
  may Float @default(0)
  jun Float @default(0)
  jul Float @default(0)
  aug Float @default(0)
  sep Float @default(0)
  oct Float @default(0)
  nov Float @default(0)
  dec Float @default(0)

  notes String?

  @@unique([budgetId, accountId])
}

// ============================================================================
// SOPs & INTERNAL WIKI
// ============================================================================

model WikiSpace {
  id     String @id @default(cuid())
  farmId String
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)

  name String
  slug String
  icon String?

  pages WikiPage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId, slug])
  @@index([farmId])
}

model WikiPage {
  id      String    @id @default(cuid())
  spaceId String
  space   WikiSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  title   String
  slug    String
  content Json // TipTap JSON format

  parentId String?
  parent   WikiPage?  @relation("PageHierarchy", fields: [parentId], references: [id])
  children WikiPage[] @relation("PageHierarchy")

  author    String
  published Boolean @default(false)

  revisions WikiRevision[]
  tags      WikiTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([spaceId, slug])
  @@index([spaceId])
}

model WikiRevision {
  id     String   @id @default(cuid())
  pageId String
  page   WikiPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  content Json
  author  String
  comment String?

  createdAt DateTime @default(now())

  @@index([pageId, createdAt])
}

model WikiTag {
  id     String @id @default(cuid())
  farmId String
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name   String

  pages WikiPage[]

  @@unique([farmId, name])
  @@index([farmId])
}

// ============================================================================
// FARM PLANNING
// ============================================================================

model Season {
  id     String @id @default(cuid())
  farmId String
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)

  name      String
  year      Int
  startDate DateTime
  endDate   DateTime

  status SeasonStatus @default(PLANNING)

  cropPlans CropPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId, year])
}

enum SeasonStatus {
  PLANNING
  ACTIVE
  COMPLETED
}

model CropPlan {
  id       String @id @default(cuid())
  seasonId String
  season   Season @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  zoneId   String
  zone     Zone   @relation(fields: [zoneId], references: [id])

  cropName String
  variety  String?

  seedDate       DateTime?
  transplantDate DateTime?
  harvestStart   DateTime?
  harvestEnd     DateTime?

  targetYield Float?
  targetUnit  String?
  actualYield Float?

  notes String?

  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seasonId])
  @@index([zoneId])
}

model Task {
  id          String @id @default(cuid())
  farmId      String
  farm        Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)
  title       String
  description String?

  type TaskType

  dueDate   DateTime?
  startDate DateTime?

  status   TaskStatus   @default(TODO)
  priority TaskPriority @default(MEDIUM)

  // Link to order item (for microgreen production tasks)
  orderItemId String?
  orderItem   OrderItem? @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  // Legacy: Keep cropPlanId for backward compatibility
  cropPlanId String?
  cropPlan   CropPlan? @relation(fields: [cropPlanId], references: [id])

  assignments TaskAssignment[]

  recurrence Json?

  // Completion log fields
  completedAt     DateTime?
  completedBy     String?   // Name of person who completed it
  completionNotes String?   // Notes from completion
  actualTrays     Int?      // Actual trays processed (may differ from expected)
  seedLot         String?   // Seed lot number for traceability

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([farmId, status])
  @@index([farmId, dueDate])
  @@index([orderItemId])
}

enum TaskType {
  // Microgreen production tasks
  SOAK
  SEED
  MOVE_TO_LIGHT
  HARVESTING

  // General farm tasks
  PLANTING
  WATERING
  FERTILIZING
  MAINTENANCE
  INSPECTION
  OTHER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model TaskAssignment {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id])
  zoneId     String?
  zone       Zone?     @relation(fields: [zoneId], references: [id])

  createdAt DateTime @default(now())

  @@index([taskId])
  @@index([employeeId])
}

// ============================================================================
// PAYMENTS
// ============================================================================

model PaymentSettings {
  id                    String  @id @default(cuid())
  farmId                String  @unique
  farm                  Farm    @relation(fields: [farmId], references: [id], onDelete: Cascade)

  // Stripe Connect
  stripeAccountId          String?
  stripeAccountStatus      String  @default("NOT_CONNECTED") // NOT_CONNECTED, PENDING, ACTIVE, RESTRICTED
  stripeOnboardingComplete Boolean @default(false)

  // PayPal Commerce Platform
  paypalMerchantId      String?
  paypalClientId        String?
  paypalAccountStatus   String  @default("NOT_CONNECTED")

  // Settings
  preferredProcessor    String  @default("STRIPE") // STRIPE or PAYPAL
  paymentTiming         String  @default("UPFRONT") // UPFRONT or ON_READY
  platformFeePercent    Float   @default(2.5)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Payment {
  id                    String    @id @default(cuid())
  farmId                String
  farm                  Farm      @relation(fields: [farmId], references: [id], onDelete: Cascade)
  orderId               String?
  order                 Order?    @relation(fields: [orderId], references: [id])

  amount                Float
  currency              String    @default("usd")
  status                String    @default("PENDING") // PENDING, PROCESSING, SUCCEEDED, FAILED, REFUNDED, PARTIALLY_REFUNDED, CANCELLED
  processor             String    @default("STRIPE") // STRIPE or PAYPAL
  platformFee           Int?      // Platform fee in cents

  // Stripe-specific fields
  stripePaymentIntentId String?
  stripePaymentLinkId   String?

  // PayPal-specific fields
  paypalOrderId         String?

  // Payment link fields
  paymentLinkId         String?   @unique
  paymentLinkUrl        String?
  paymentLinkExpiresAt  DateTime?

  customerEmail         String?
  customerName          String?
  description           String?

  // Result fields
  paidAt                DateTime?
  failureReason         String?
  refundedAmount        Float?
  refundedAt            DateTime?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([farmId])
  @@index([orderId])
  @@index([stripePaymentIntentId])
  @@index([paypalOrderId])
}

model StripeWebhookEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  eventType     String
  processed     Boolean  @default(false)
  error         String?
  createdAt     DateTime @default(now())
}
